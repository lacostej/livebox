#!/bin/bash
#
# list livebox deconnections date time
#
usage() {
  name=`basename "$0"`
  cat << EOF
usage: $name [filename]

This script returns the deconnection times as stored in the log file.

If filename isn't specified, it uses the standard input as input (cat filename | $name)
EOF
}
if [ $# -gt 1 ]; then
  usage
  exit 1
fi

if [ $# -eq 1 ]; then
  file=$1
  if [ ! -f $file ]; then
    echo "File $file doesn't exist"
    usage
    exit 1
  fi
fi
awk '
BEGIN{ 
  print "#Last connection; Last disconnection; duration"
  last_timestamp = 0; nbdisconnections=0; last_disconnect=""
}
{ 
  if (match($0, /.*;(.*);(.*);(.*)/, a)) {
    new_start=a[1]
    new_duration=a[2]
    new_disconnect = a[3]
    if (length(new_duration) > 0) {
      last_duration=new_duration
    }
    if (match(new_disconnect, /.*, (.*)/, b)) {
      since=b[1]
      new_timestamp = strptime(since, hour, min, sec)

      if (last_disconnect=="") {
        last_disconnect = new_disconnect
        last_timestamp = new_timestamp
      }
      # detect disconnect, we have a new start timestamp
      # start time is precise up to one second
      if (new_timestamp - last_timestamp > 1) {
        last_timestamp = new_timestamp
        from = last_duration == "" ? last_disconnect : new_start
        to=new_disconnect

        print from " ; " to " ; " last_duration
        to=""
        last_duration=""
        last_disconnect = new_disconnect
        nbdisconnections++
      }
    }
  }
}
END {
  from = last_duration == "" ? last_disconnect : new_start
  print from " ; " to " ; " last_duration
}
function strptime(str,    hour,min,sec) {
  hour=strtonum(substr(str, 0, 2))
  min=strtonum(substr(str, 4, 2))
  sec=strtonum(substr(str, 7, 2))
  return hour*3600+min*60+sec
}
' $*

